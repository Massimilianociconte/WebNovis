const _isLocal="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname,CHAT_CONFIG={apiEndpoint:_isLocal?"http://localhost:3000/api/chat":"https://webnovis-chat.onrender.com/api/chat",leadEndpoint:_isLocal?"http://localhost:3000/api/chat-lead":"https://webnovis-chat.onrender.com/api/chat-lead",healthCheckUrl:_isLocal?"http://localhost:3000/api/health":"https://webnovis-chat.onrender.com/api/health",maxMessageLength:500,maxHistoryLength:8,minTypingTime:600,maxTypingTime:2200,keepAliveInterval:3e5,maxRetries:2,retryDelay:1200,storageKey:"weby_chat_session",storageExpiry:18e5},LEAD_INTENT_PATTERNS=[/preventiv|quotazion|offerta/i,/voglio (un sito|un logo|un ecommerce|iniziare|parlare|essere contattato)/i,/contatt(ami|atemi|armi)|chiamat(emi|ami)|ricontatt/i,/interessat[oa]|vorrei (sapere|un|una|iniziare)|ho bisogno|mi serve/i,/quando possiamo|come si inizia|come faccio a iniziare|mandate un preventivo/i],isMobileChat=window.innerWidth<=768||"ontouchstart"in window;document.addEventListener("DOMContentLoaded",function(){const e={button:document.getElementById("chatButton"),popup:document.getElementById("chatPopup"),close:document.getElementById("chatClose"),input:document.getElementById("chatInput"),send:document.getElementById("chatSend"),messages:document.getElementById("chatMessages"),bubble:document.getElementById("webyBubble"),bubbleClose:document.getElementById("webyBubbleClose")};if(!e.button||!e.popup)return;let t={isOpen:!1,isTyping:!1,history:[],hasInteracted:!1,scrollLocked:!1,leadCaptured:!1,messageCount:0,sessionId:Date.now().toString(36)},n=null;if(window,function(){try{const n=localStorage.getItem(CHAT_CONFIG.storageKey);if(!n)return;const o=JSON.parse(n);if(Date.now()-o.savedAt>CHAT_CONFIG.storageExpiry)return void localStorage.removeItem(CHAT_CONFIG.storageKey);if(!Array.isArray(o.history)||0===o.history.length)return;t.history=o.history,t.sessionId=o.sessionId||t.sessionId,setTimeout(()=>{if(!e.messages)return;const n=document.createElement("div");n.style.cssText="text-align:center;font-size:0.65rem;color:rgba(255,255,255,0.22);padding:4px 0 8px;letter-spacing:0.04em;",n.textContent="â€” conversazione precedente â€”",e.messages.appendChild(n),t.history.slice(-4).forEach(e=>{i(e.content,"user"===e.role?"user":"bot")}),l()},150)}catch(e){localStorage.removeItem(CHAT_CONFIG.storageKey)}}(),e.button.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),t.isOpen=!t.isOpen,e.popup.classList.toggle("active",t.isOpen),t.isOpen?(e.bubble&&e.bubble.classList.add("hidden"),isMobileChat&&(document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%"),setTimeout(()=>e.input?.focus(),isMobileChat?300:100),l()):isMobileChat&&(document.body.style.overflow="",document.body.style.position="",document.body.style.width="")}),e.close&&e.close.addEventListener("click",()=>o()),e.bubbleClose&&e.bubbleClose.addEventListener("click",t=>{t.stopPropagation(),e.bubble&&e.bubble.classList.add("hidden")}),e.input){e.input.setAttribute("maxlength",CHAT_CONFIG.maxMessageLength);const o=e.input.parentElement;n=document.createElement("span"),n.className="chat-char-counter",n.style.cssText="position:absolute;bottom:28px;right:60px;font-size:0.65rem;color:rgba(255,255,255,0.25);pointer-events:none;transition:color 0.2s;",o&&(o.style.position="relative",o.appendChild(n)),e.input.addEventListener("input",()=>{const t=CHAT_CONFIG.maxMessageLength-e.input.value.length;t<=80?(n.textContent=t,n.style.color=t<=20?"rgba(239,68,68,0.7)":"rgba(255,255,255,0.35)"):n.textContent=""}),e.input.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),a())}),e.input.addEventListener("focus",function(){isMobileChat&&(t.scrollLocked=!0,setTimeout(()=>{l(),e.popup&&(e.popup.style.bottom="0",e.popup.style.height="100%",e.popup.style.maxHeight="100vh",e.popup.style.borderRadius="0")},300))}),e.input.addEventListener("blur",function(){isMobileChat&&(t.scrollLocked=!1,setTimeout(()=>{e.popup&&t.isOpen&&(e.popup.style.bottom="",e.popup.style.height="",e.popup.style.maxHeight="",e.popup.style.borderRadius="")},100))})}function o(){t.isOpen=!1,e.popup.classList.remove("active"),isMobileChat&&(document.body.style.overflow="",document.body.style.position="",document.body.style.width="")}function i(t,n="bot"){const o=document.createElement("div");o.className="chat-message "+("user"===n?"user-message":"bot-message");const i="user"===n?"TU":"WN",a=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});let s=function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(t);"bot"===n&&(s=s.replace(/\n/g,"<br>").replace(/(hello@webnovis\.com)/g,'<a href="mailto:$1" style="color:#a8b4f8;text-decoration:underline;">$1</a>').replace(/wa\.me\/(\S+)/g,'<a href="https://wa.me/$1" target="_blank" rel="noopener noreferrer" style="color:#a8b4f8;text-decoration:underline;">WhatsApp</a>').replace(/(https?:\/\/(?!wa\.me)[^\s<"]+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer" style="color:#a8b4f8;text-decoration:underline;">$1</a>')),o.innerHTML=`\n            <div class="message-avatar">${i}</div>\n            <div class="message-content">\n                <p>${s}</p>\n                <span class="message-time">${a}</span>\n            </div>\n        `,e.messages.appendChild(o),l()}async function a(){if(t.isTyping)return;let o=e.input.value.trim();if(o){o.length>CHAT_CONFIG.maxMessageLength&&(o=o.substring(0,CHAT_CONFIG.maxMessageLength)),e.input.value="",n&&(n.textContent=""),t.hasInteracted=!0,t.messageCount++,e.send&&(e.send.disabled=!0),i(o,"user"),function(){t.isTyping=!0;const n=document.createElement("div");n.id="typingIndicator",n.className="chat-message bot-message typing-indicator",n.innerHTML='\n            <div class="message-avatar">WN</div>\n            <div class="message-content">\n                <div class="typing-dot"></div>\n                <div class="typing-dot"></div>\n                <div class="typing-dot"></div>\n            </div>\n        ',e.messages.appendChild(n),l()}(),!t.leadCaptured&&function(e){return LEAD_INTENT_PATTERNS.some(t=>t.test(e))}(o)&&(t.leadCaptured=!0,function(e){try{fetch(CHAT_CONFIG.leadEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e.substring(0,300),sessionId:t.sessionId,page:window.location.pathname,messageCount:t.messageCount})}).catch(()=>{})}catch(e){}}(o));try{const e=await async function(e){for(let t=0;t<=CHAT_CONFIG.maxRetries;t++)try{return await s(e,t)}catch(e){t<CHAT_CONFIG.maxRetries&&await new Promise(e=>setTimeout(e,CHAT_CONFIG.retryDelay*(t+1)))}return r(e)}(o);c(),i(e,"bot"),t.history.push({role:"user",content:o}),t.history.push({role:"assistant",content:e}),t.history.length>2*CHAT_CONFIG.maxHistoryLength&&(t.history=t.history.slice(2*-CHAT_CONFIG.maxHistoryLength)),function(){try{localStorage.setItem(CHAT_CONFIG.storageKey,JSON.stringify({history:t.history,sessionId:t.sessionId,savedAt:Date.now()}))}catch(e){}}()}catch(e){c(),i("Ops, qualcosa non ha funzionato. Riprova tra un momento o scrivici a hello@webnovis.com ï¿½","bot")}finally{e.send&&(e.send.disabled=!1),e.input?.focus()}}}async function s(e,n=0){const o=Date.now(),i=new AbortController,a=setTimeout(()=>i.abort(),8e3+2e3*n);try{const n=await fetch(CHAT_CONFIG.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,conversationHistory:t.history,sessionId:t.sessionId}),signal:i.signal});if(clearTimeout(a),!n.ok)throw new Error(`API Error: ${n.status}`);const s=await n.json(),c=s.response||s.fallback||"",l=Date.now()-o,p=Math.min(CHAT_CONFIG.maxTypingTime,Math.max(CHAT_CONFIG.minTypingTime,10*c.length));return l<p&&await new Promise(e=>setTimeout(e,p-l)),c||r(e)}catch(e){throw clearTimeout(a),e}}function r(e){const t=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");return t.match(/^(ciao|salve|buongiorno|buonasera|hey|hello|hi|hola|salut)/)?"Ciao! ðŸ‘‹ Sono Weby, l'assistente di WebNovis.\nLavoriamo su siti web, grafica e social media.\n\nCosa posso fare per te oggi?":t.match(/(grazie|thanks|ok perfetto|ottimo|grande|fantastico|perfetto)/)?"Prego! ðŸ˜Š Se hai altre domande sono qui.\nBuona giornata!":t.match(/(prezz|cost|quanto|tariff|listino|budget|preventiv)/)?"Ecco i prezzi di partenza ðŸ‘‡\n\nðŸŒ Web:\nâ€¢ Landing Page: da â‚¬500\nâ€¢ Sito Vetrina: da â‚¬1.200\nâ€¢ E-commerce: da â‚¬3.500\n\nðŸŽ¨ Design:\nâ€¢ Logo: da â‚¬150\nâ€¢ Brand Identity: da â‚¬450\n\nðŸ“± Social Media: da â‚¬300/mese\n\nI preventivi sono sempre gratuiti e su misura.\nVuoi che ti prepariamo uno personalizzato?":t.match(/(caro|costoso|troppo|non ho budget|poco budget|economico|conveniente|scontare)/)?"Capisco! ðŸ’¡\nUn sito professionale lavora per te 24/7 â€” Ã¨ un investimento, non una spesa.\n\nPossiamo strutturare il progetto in fasi per distribuire il costo.\n\nVuoi un preventivo gratuito su misura per il tuo budget?":t.match(/(devo pensare|ci penso|non sono sicuro|forse|magari|vedremo|non so)/)?"Assolutamente, prenditi il tempo che ti serve! ðŸ˜Š\n\nPosso inviarti un preventivo dettagliato via email cosÃ¬ hai tutto nero su bianco.\n\nQual Ã¨ la tua email? Rispondo entro 24 ore, senza impegno.":t.match(/(ho gia|ho gi|sito esistente|restyling|rifacimento|aggiornare il sito|migliorare il sito)/)?"Ottimo punto di partenza! ðŸ”\nSpesso un restyling o un'ottimizzazione SEO del sito esistente fa la differenza.\n\nPossiamo analizzare gratuitamente il tuo sito attuale.\nManda l'URL a hello@webnovis.com â€” ti diciamo cosa migliorare!":t.match(/(sito|web|ecommerce|e-commerce|landing|pagina|app|wordpress|shopify|negozio online)/)?"Creiamo siti web professionali e performanti! ðŸš€\n\nâ€¢ Design su misura (zero template)\nâ€¢ Responsive su ogni dispositivo\nâ€¢ SEO tecnica inclusa\nâ€¢ E-commerce scalabili\n\nPrezzi da â‚¬500 per una landing page.\n\nVuoi vedere il portfolio o ricevere un preventivo gratuito?":t.match(/(social|instagram|facebook|tiktok|linkedin|post|content|ads|campagn|advertising)/)?"Supportiamo la tua presenza social! ðŸ“±\n\nâ€¢ Analisi competitor e ricerche di marketing\nâ€¢ Contenuti grafici pronti per la pubblicazione\nâ€¢ Campagne Meta Ads gestite\n\nNota: non gestiamo profili o pubblicazioni quotidiane.\n\nPacchetti da â‚¬300/mese.\nVuoi sapere quale fa per te?":t.match(/(logo|grafica|brand|design|identit|visual|stampa|flyer|brochure|packaging|coordinato)/)?"Creiamo identitÃ  visive memorabili! âœ¨\n\nâ€¢ Logo professionale: da â‚¬150\nâ€¢ Brand Identity completa: da â‚¬450\nâ€¢ Materiale stampa: preventivo\nâ€¢ Packaging: preventivo\n\nTutto disegnato da zero, nessun template!\n\nVuoi vedere esempi nel portfolio?":t.match(/(foto|video|shooting|fotografic|ripres|editing|post-produzion)/)?"Offriamo servizi foto e video professionali! ðŸ“¸\n\nâ€¢ Shooting prodotto\nâ€¢ Ritratti aziendali\nâ€¢ Video promo\nâ€¢ Editing avanzato\n\nDa â‚¬150/sessione.\n\nVuoi maggiori dettagli o un preventivo?":t.match(/(tempo|quanto ci vuole|tempi|consegna|settiman|giorni|veloce|urgent|scadenza)/)?"I tempi variano in base alla complessitÃ  ðŸ“…\n\nâ€¢ Landing Page: 1-2 settimane\nâ€¢ Sito Vetrina: 3-4 settimane\nâ€¢ E-commerce: 6-8 settimane\nâ€¢ Logo: 1-2 settimane\nâ€¢ Brand Identity: 2-4 settimane\nâ€¢ Social: attivazione in 5 giorni\n\nHai una data di lancio in mente?":t.match(/(come funzion|processo|come lavora|metodo|step|fasi|procedur|come si inizia)/)?"Il nostro processo in 5 step âš¡\n\n1ï¸âƒ£ Analisi gratuita delle tue esigenze\n2ï¸âƒ£ Mockup su misura\n3ï¸âƒ£ Revisione condivisa\n4ï¸âƒ£ Sviluppo tecnico\n5ï¸âƒ£ Lancio + supporto continuo\n\nVuoi iniziare con una consulenza gratuita?":t.match(/(portfolio|esemp|lavori|progett|client|referenz)/)?"Puoi vedere i nostri lavori su webnovis.com/portfolio.html ðŸŽ¯\n\nAlcuni progetti: Mikuna, FB Total Security, QuickSEO, DreamSense, Mimmo Fratelli e altri.\n\nVuoi info su un progetto specifico?":t.match(/(contatt|email|parlare|scrivere|chiamare|telefon|whatsapp|ricontatt)/)?"Puoi contattarci cosÃ¬ ðŸ“§\n\nâ€¢ Email: hello@webnovis.com\nâ€¢ WhatsApp: wa.me/393802647367\nâ€¢ Form contatti: qui sotto nella pagina\n\nRispondiamo entro 24 ore!":t.match(/(support|aiuto|problema|assist|manutenzione|aggiornament)/)?"Offriamo supporto dedicato! ðŸ› ï¸\n\nâ€¢ Chatbot (io!)\nâ€¢ WhatsApp\nâ€¢ Email: hello@webnovis.com\n\nAssistenza continua anche dopo il lancio.\n\nCome posso aiutarti?":t.match(/(seo|posizionamento|google|indicizzazione|ranking)/)?"Ottimizziamo i siti per Google! ðŸ”\n\nâ€¢ SEO tecnica on-page\nâ€¢ Struttura ottimizzata per i motori di ricerca\nâ€¢ Performance e velocitÃ \nâ€¢ Schema.org e dati strutturati\n\nL'ottimizzazione SEO Ã¨ inclusa in tutti i nostri siti web!\n\nVuoi saperne di piÃ¹?":t.match(/(chi siete|chi sei|chi e webnovis|di cosa vi occupate|cosa fate|presentati)/)?"Sono Weby, l'assistente di Web Novis! ðŸ‘‹\n\nWebNovis Ã¨ un'agenzia digitale italiana con sede a Rho (MI).\nCi occupiamo di siti web, grafica, branding e social media.\n\nFilosofia: design 100% su misura, zero template, SEO inclusa.\n\nVuoi vedere il portfolio o ricevere un preventivo gratuito?":"Posso aiutarti con i servizi WebNovis:\n\nðŸŒ Siti web ed e-commerce\nðŸŽ¨ Logo, grafica e branding\nðŸ“± Social media e advertising\nðŸ“¸ Foto e video\n\nCosa ti interessa? ðŸ˜Š"}function c(){t.isTyping=!1;const e=document.getElementById("typingIndicator");e&&e.remove()}function l(){requestAnimationFrame(()=>{e.messages&&(e.messages.scrollTop=e.messages.scrollHeight)})}e.send&&e.send.addEventListener("click",a),document.querySelectorAll(".quick-reply").forEach(t=>{t.addEventListener("click",function(){const t=this.dataset.message;if(t){e.input.value=t,a();const n=this.parentElement;n.style.opacity="0",setTimeout(()=>n.remove(),300)}})}),isMobileChat||document.addEventListener("click",n=>{!t.isOpen||e.popup.contains(n.target)||e.button.contains(n.target)||o()}),setTimeout(()=>{t.isOpen||t.hasInteracted||!e.bubble||e.bubble.classList.add("visible")},isMobileChat?5e3:3e3),"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(setInterval(()=>{fetch(CHAT_CONFIG.healthCheckUrl).catch(()=>{})},CHAT_CONFIG.keepAliveInterval),fetch(CHAT_CONFIG.healthCheckUrl).catch(()=>{}))});